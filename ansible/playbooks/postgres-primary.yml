---
# Unified playbook for PostgreSQL Primary
# Works for both Docker testing and production VMs
#
# Usage:
#   Docker:      ansible-playbook -i inventory/hosts-docker-test.yml playbooks/postgres-primary.yml
#   Production:  ansible-playbook playbooks/postgres-primary.yml
#
# This targets all hosts in the 'postgres' group that have 'primary' in their name

- name: Configure PostgreSQL Primary Server
  hosts: postgres:&*primary*
  become: yes

  roles:
    - common             # Install base packages, create testuser
    - postgres-primary   # Install and configure PostgreSQL

  tasks:
    - name: Verify PostgreSQL is running
      service:
        name: postgresql
        state: started
      tags: verify
      ignore_errors: yes  # May not work in Docker without systemd

    - name: Test PostgreSQL connection
      command: sudo -u postgres psql -c "SELECT version();"
      register: postgres_version
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display PostgreSQL version
      debug:
        var: postgres_version.stdout_lines
      when: postgres_version.rc == 0
      tags: verify

    - name: Check replication status
      command: sudo -u postgres psql -c "SELECT * FROM pg_stat_replication;"
      register: replication_status
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display replication status
      debug:
        var: replication_status.stdout_lines
      when: replication_status.rc == 0
      tags: verify
