---
# Unified playbook for MariaDB Replica
# Works for both Docker testing and production VMs
#
# Usage:
#   Docker:      ansible-playbook -i inventory/hosts-docker-test.yml playbooks/mariadb-replica.yml
#   Production:  ansible-playbook playbooks/mariadb-replica.yml
#
# This targets all hosts in the 'mariadb' group that have 'replica' in their name

- name: Configure MariaDB Replica Server
  hosts: mariadb:&*replica*
  become: yes

  roles:
    - common           # Install base packages, create testuser
    - mariadb-replica  # Install and configure MariaDB replica

  tasks:
    - name: Verify MariaDB is running
      service:
        name: mariadb
        state: started
      tags: verify
      ignore_errors: yes  # May not work in Docker without systemd

    - name: Test MySQL connection
      command: mysql -u app_user -papp_password -e "SELECT VERSION();"
      register: mysql_version
      changed_when: false
      failed_when: false
      tags: verify

    - name: Show MySQL version
      debug:
        var: mysql_version.stdout_lines
      when: mysql_version.rc == 0
      tags: verify

    - name: Check replica status
      command: mysql -u root -e "SHOW SLAVE STATUS\G"
      register: slave_status
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display replica status
      debug:
        var: slave_status.stdout_lines
      when: slave_status.rc == 0
      tags: verify
