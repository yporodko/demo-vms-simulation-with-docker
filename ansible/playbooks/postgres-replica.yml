---
# Unified playbook for PostgreSQL Replica
# Works for both Docker testing and production VMs
#
# Usage:
#   Docker:      ansible-playbook -i inventory/hosts-docker-test.yml playbooks/postgres-replica.yml
#   Production:  ansible-playbook playbooks/postgres-replica.yml
#
# This targets all hosts in the 'postgres' group that have 'replica' in their name

- name: Configure PostgreSQL Replica Servers
  hosts: postgres:&*replica*
  become: yes

  roles:
    - common            # Install base packages, create testuser
    - postgres-replica  # Install and configure PostgreSQL replica

  tasks:
    - name: Verify PostgreSQL is running
      service:
        name: postgresql
        state: started
      tags: verify
      ignore_errors: yes  # May not work in Docker without systemd

    - name: Test PostgreSQL connection
      command: sudo -u postgres psql -c "SELECT version();"
      register: postgres_version
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display PostgreSQL version
      debug:
        var: postgres_version.stdout_lines
      when: postgres_version.rc == 0
      tags: verify

    - name: Check if server is in recovery (replica mode)
      command: sudo -u postgres psql -c "SELECT pg_is_in_recovery();"
      register: recovery_status
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display recovery status
      debug:
        var: recovery_status.stdout_lines
      when: recovery_status.rc == 0
      tags: verify

    - name: Check replication lag
      command: sudo -u postgres psql -c "SELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0 ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp()) END AS replication_lag_seconds;"
      register: replication_lag
      changed_when: false
      failed_when: false
      tags: verify

    - name: Display replication lag
      debug:
        var: replication_lag.stdout_lines
      when: replication_lag.rc == 0
      tags: verify
