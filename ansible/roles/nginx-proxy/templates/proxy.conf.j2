# Nginx Reverse Proxy Configuration - Managed by Ansible
# With DDoS Protection

server {
    listen {{ nginx_proxy_port }};
    server_name _;

    ##
    # DDoS Protection - Apply Rate Limiting
    ##
    # Limit requests per second per IP
    limit_req zone=req_limit_per_ip burst={{ ddos_rate_limit_burst }} nodelay;

    # Limit connections per IP
    limit_conn conn_limit_per_ip {{ ddos_conn_limit_per_ip }};

    # Limit total connections to this server
    limit_conn conn_limit_total {{ ddos_conn_limit_total }};

    # Return 429 (Too Many Requests) when limits are hit
    limit_req_status 429;
    limit_conn_status 429;

{% if nginx_security_headers %}
    ##
    # Security Headers
    ##
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
{% endif %}

    ##
    # Health Check Endpoint
    ##
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    ##
    # Status Page (for monitoring)
    ##
    location /nginx-status {
        stub_status on;
        access_log off;
        # In production, restrict to monitoring IPs
        # allow 10.0.0.0/8;
        # deny all;
    }

    ##
    # Main Proxy Location
    ##
    location / {
        proxy_pass http://{{ nginx_upstream_name }};

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Connection settings
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Proxy timeouts
        proxy_connect_timeout {{ nginx_proxy_connect_timeout }};
        proxy_send_timeout {{ nginx_proxy_send_timeout }};
        proxy_read_timeout {{ nginx_proxy_read_timeout }};

        # Proxy buffer settings
        proxy_buffer_size {{ nginx_proxy_buffer_size }};
        proxy_buffers {{ nginx_proxy_buffers }};
        proxy_busy_buffers_size {{ nginx_proxy_busy_buffers_size }};

        # Add backend server header for debugging
        add_header X-Upstream-Server $upstream_addr always;
    }
}
