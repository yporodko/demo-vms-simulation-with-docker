#!/usr/bin/env python3
"""
Simple Web Application for Load Balancer Testing
Managed by Ansible - DO NOT EDIT MANUALLY
"""

import http.server
import socketserver
import socket
import json
import os
from datetime import datetime

PORT = {{ app_port }}

class AppHandler(http.server.BaseHTTPRequestHandler):
    def do_GET(self):
        # Get server information
        hostname = socket.gethostname()
        try:
            ip_address = socket.gethostbyname(hostname)
        except:
            ip_address = "unknown"

        # Build response
        response_data = {
            "status": "ok",
            "hostname": hostname,
            "ip_address": ip_address,
            "path": self.path,
            "timestamp": datetime.now().isoformat(),
            "headers": dict(self.headers)
        }

        # Health check endpoint
        if self.path == "/health":
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            self.wfile.write(json.dumps({"status": "healthy", "hostname": hostname}).encode())
            return

        # Main response
        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.send_header("X-Backend-Server", hostname)
        self.end_headers()
        self.wfile.write(json.dumps(response_data, indent=2).encode())

    def log_message(self, format, *args):
        print(f"[{datetime.now().isoformat()}] {self.address_string()} - {format % args}")

if __name__ == "__main__":
    with socketserver.TCPServer(("0.0.0.0", PORT), AppHandler) as httpd:
        print(f"Server running on port {PORT}")
        print(f"Hostname: {socket.gethostname()}")
        httpd.serve_forever()
